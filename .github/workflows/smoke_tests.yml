name: Smoke Tests

on:
  schedule:
    - cron: "0 10 * * *" # Nightly, 10:00 UTC / 02:00 Pacific
  workflow_dispatch:

permissions: read-all

env:
  CARGO_TERM_COLOR: always

jobs:
  smoke-test:
    name: ${{ matrix.project }}-rv
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - diaspora
          - discourse
          - fastlane
          - gitlab
          - homebrew
          - huginn
          - lobsters
          - mastodon
    steps:
      - name: Check out repo
        uses: actions/checkout@v6

      - name: rv clean-install for ${{ matrix.project }}
        run: bin/smoke-tests/${{ matrix.project }}

  baseline:
    name: ${{ matrix.project }}-baseline
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - project: gitlab
            repo: https://gitlab.com/gitlab-org/gitlab.git
            deps: >-
              build-essential git ca-certificates pkg-config cmake
              libyaml-dev libre2-dev libffi-dev libxml2-dev libxslt-dev
              libcurl4-openssl-dev libicu-dev libkrb5-dev libpq-dev
              libpcre2-dev libgpgme-dev zlib1g-dev
          - project: lobsters
            repo: https://github.com/lobsters/lobsters.git
            deps: >-
              build-essential git ca-certificates
              libyaml-dev libmariadb-dev libsqlite3-dev
    steps:
      - name: Check out repo
        uses: actions/checkout@v6

      - name: Clone ${{ matrix.project }}
        run: git clone --depth 1 ${{ matrix.repo }} ${{ matrix.project }}

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends ${{ matrix.deps }}

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          working-directory: ${{ matrix.project }}

      - name: Run bundle install
        working-directory: ${{ matrix.project }}
        run: bundle install
