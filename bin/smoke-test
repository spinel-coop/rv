#!/bin/bash
set -euo pipefail

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
name="${1:-}"

if [[ -z "$name" ]]; then
  # shellcheck disable=SC2012
  tests="$(ls "$DIR/smoke-tests" | tr '\n' '|')"
  echo "USAGE: smoke-test [$tests]"
  exit 1
fi

shift
if [[ "$(uname)" == "Darwin" ]]; then
  if ! docker container inspect rv-smoke-test-diaspora >/dev/null 2>&1; then
    set -x
    docker run -it -v .:/src --name "rv-smoke-test-$name" rust:latest "/src/bin/smoke-tests/$name" "$@"
  else
    set -x
    docker start -ia "rv-smoke-test-$name"
  fi
else
  set -x
  exec "$DIR/smoke-tests/$name" "$@"
fi
