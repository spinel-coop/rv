#!/usr/bin/env bash
set -euo pipefail

# Integration test: run rv on Arch Linux
# Cross-compiles rv for x86_64 Linux, then runs it in an Arch container

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

TARGET="x86_64-unknown-linux-gnu"

echo "Cross-compiling rv for $TARGET..."
cargo zigbuild --release --target "$TARGET" --locked --all-features --bin rv --manifest-path "$ROOT_DIR/Cargo.toml"

echo "Running rv in Arch Linux container..."
docker run --rm --platform linux/amd64 \
    -v "$ROOT_DIR/target/$TARGET/release/rv:/usr/local/bin/rv:ro" \
    archlinux:base \
    sh -c "rv --version && rv --help"

echo ""
echo "Integration test for Arch passed!"
