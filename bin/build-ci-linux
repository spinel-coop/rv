#!/bin/sh
set -eu

# Build rv for Linux (matching host architecture)
# Uses cargo-zigbuild for cross-compilation on non-Linux systems
# Requires: zig, cargo-zigbuild (cargo install cargo-zigbuild)

DIR="$(cd "$(dirname "$0")/.." && pwd)"

cd "$DIR"

# Determine target based on host
case "$(uname -s)-$(uname -m)" in
    Linux-x86_64)
        # Native build on Linux x86_64
        exec cargo build --release --locked --all-features --bin rv
        ;;
    Linux-aarch64)
        # Native build on Linux arm64
        exec cargo build --release --locked --all-features --bin rv
        ;;
    Darwin-arm64)
        # Cross-compile to Linux arm64
        TARGET="aarch64-unknown-linux-gnu"
        exec cargo zigbuild --release --target "$TARGET" --locked --all-features --bin rv
        ;;
    Darwin-x86_64)
        # Cross-compile to Linux x86_64
        TARGET="x86_64-unknown-linux-gnu"
        exec cargo zigbuild --release --target "$TARGET" --locked --all-features --bin rv
        ;;
    *)
        echo "Unsupported platform: $(uname -s)-$(uname -m)" >&2
        exit 1
        ;;
esac
