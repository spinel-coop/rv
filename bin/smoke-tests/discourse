#!/usr/bin/env bash
set -euo pipefail

# Smoke test for Discourse
# https://github.com/discourse/discourse

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
SMOKE_TEST_DIR="$ROOT_DIR/temp/smoke-tests"
PROJECT_DIR="$SMOKE_TEST_DIR/discourse"
RV="$ROOT_DIR/target/release/rv"

# Clone if needed
mkdir -p "$SMOKE_TEST_DIR"
if [ ! -d "$PROJECT_DIR" ]; then
    echo "Cloning discourse..."
    git clone --depth 1 https://github.com/discourse/discourse.git "$PROJECT_DIR"
else
    echo "discourse already cloned, using existing copy"
fi

cd "$PROJECT_DIR"

echo "Installing Ruby version for discourse..."
"$RV" ruby install

echo "Running rv ci for discourse..."
"$RV" ci

echo "Smoke test for discourse passed!"
