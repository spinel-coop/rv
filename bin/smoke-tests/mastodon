#!/bin/bash
set -euo pipefail

# Smoke test for Mastodon - https://github.com/mastodon/mastodon
# On macOS, you can run this script via Docker:
# $ docker run -it --rm -v .:/src ubuntu:latest /src/bin/smoke-tests/mastodon

# Use sudo if available (needed in GHA), skip if not (Docker runs as root)
SUDO=""
if command -v sudo &> /dev/null; then
    SUDO="sudo"
fi

export DEBIAN_FRONTEND=noninteractive
$SUDO apt-get update
$SUDO apt-get install -y --no-install-recommends \
    build-essential \
    git \
    ca-certificates \
    curl \
    libyaml-dev \
    libpq-dev \
    libicu-dev \
    libidn-dev \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    libpam0g-dev

# Install rv from latest release
echo ""
echo "Installing rv..."
curl --proto '=https' --tlsv1.2 -LsSf https://github.com/spinel-coop/rv/releases/latest/download/rv-installer.sh | sh
source "$HOME/.cargo/env"

[[ -d mastodon ]] || git clone --depth 1 https://github.com/mastodon/mastodon.git
cd mastodon

rv ci

echo ""
echo "Success: mastodon smoke test passed"
