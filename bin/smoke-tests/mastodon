#!/bin/bash
set -euo pipefail

# Smoke test for Mastodon - https://github.com/mastodon/mastodon

source "$(dirname "$0")/shared.sh"

macos_docker_reexec

setup_packages \
    libyaml-dev \
    libpq-dev \
    libicu-dev \
    libidn-dev \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    libpam0g-dev

setup_rv

[[ -d mastodon ]] || git clone --depth 1 https://github.com/mastodon/mastodon.git
cd mastodon

rv ci

rv run bundle check

smoke_test_success "mastodon"
