#!/bin/bash
set -euo pipefail

# Smoke test for Homebrew - https://github.com/Homebrew/brew

source "$(dirname "$0")/shared.sh"

macos_docker_reexec

setup_packages \
    libffi-dev \
    libyaml-dev \
    python3-dev

setup_rv

[[ -d brew ]] || git clone --depth 1 https://github.com/Homebrew/brew.git
cd brew/Library/Homebrew

# This repo includes some gems in `vendor/bundle` partially installed: the gems
# code is properly installed in the `gems/` folder, but specifications are not
# present in `specifications/`. We can't (yet?) heal these partial installs, so
# we reinstall everything for now
rv ci --force

rv run bundle check

smoke_test_success "homebrew"
